---
description: Rules for Express API, MikroORM entities, routing, and validation
globs:
  - 'apps/api/**'
---

# API Rules

- Use Express routers per resource under `apps/api/src/routes/*`.
- Validate all request bodies with Zod before DB writes.
- Use MikroORM entities in `apps/api/src/entities/*`. Keep entities focused.
- API is mounted under `/api`; keep this consistent with web defaults and `README.md`.
- Implement proper request/response logging with structured data.
- Use consistent API response format with proper status codes.
- Implement rate limiting for all endpoints.
- Add proper CORS configuration for production environments.

# Database & Entities

- Use MikroORM entities in `apps/api/src/entities/*`. Keep entities focused.
- Use PostgreSQL as the database with MikroORM as the ORM.
- Always define proper indexes using `@Index()` decorator for query performance.
- Use MikroORM's unit of work pattern for transactional operations.
- Implement proper data validation at the entity level with decorators.
- Use QueryBuilder or EntityManager for complex queries.
- Implement proper pagination for list endpoints.
- Use proper error handling for database connection issues.
- Configure connection pooling in `mikro-orm.config.ts`.

## Query-Level Filtering (CRITICAL)

**ALWAYS filter data at the database level, NEVER in JavaScript after fetching.**

❌ **BAD - In-memory filtering:**

```typescript
// Fetches ALL templates, then filters in JS - breaks pagination, wastes memory
const templates = await em.find(Template, { company: companyId });
const filtered = templates.filter(t => t.state === 'CA');
```

✅ **GOOD - SQL-level filtering:**

```typescript
// Filters at database level - correct pagination, uses indexes
const templates = await em.find(Template, {
  company: companyId,
  state: 'CA',
});
```

### Complex Filters with PostgreSQL

**Array containment** (for array columns like `includedStates`):

```typescript
import { raw } from '@mikro-orm/core';

// Check if array contains a value
filter['$and'] = [raw(`included_states @> ARRAY[?]::text[]`, [state])];
```

**M2M relationship filtering** (for pivot tables):

```typescript
// Use EXISTS subqueries for M2M filtering
filter['$and'] = [
  raw(
    `(
    NOT EXISTS (SELECT 1 FROM pivot_table WHERE fk = entity.id)
    OR EXISTS (SELECT 1 FROM pivot_table WHERE fk = entity.id AND other_fk = ?)
  )`,
    [targetId],
  ),
];
```

**Why this matters:**

- In-memory filtering breaks pagination (fetch 50, filter to 10 = missing data)
- Database can use indexes for fast filtering
- Reduces memory usage and data transfer
- Enables proper `LIMIT`/`OFFSET` pagination

## Entity Registration Checklist (CRITICAL)

When creating a new entity, you MUST register it in TWO places:

1. **Export from `entities/index.ts`**:

   ```typescript
   export { MyNewEntity } from './MyNewEntity.entity';
   ```

2. **Add to `entities` array in `lib/db.ts`** (single source of truth):
   - Add import: `import { MyNewEntity } from '../entities';`
   - Add to the exported `entities` array: `MyNewEntity,`

**Note:** `mikro-orm.config.ts` imports the `entities` array from `db.ts`, so you only need to add entities in one place.

**Why both?** Missing registration causes:

- Missing from `entities/index.ts`: Import errors in other files
- Missing from `lib/db.ts`: Runtime errors, failing integration tests, and migration generation failures

# Shared Types

- Use shared types from `@shared/core` for API request/response types.
- Define request/response types in `packages/shared/src/types/` for consistency between API and web.
- Import types: `import type { UserListItem, Role } from '@shared/core';`

# Error Handling

- Fail fast on validation with 400 and formatted zod error.
- Log server errors with pino; never leak stack traces to clients.
- Use typed error classes extending Error for different error types.
- Always provide meaningful error messages for client-facing errors.
- Use proper HTTP status codes (400 for validation, 401 for auth, 403 for forbidden, 404 for not found, 500 for server errors).
- Implement centralized error handling middleware.
- Validate all inputs with Zod schemas before processing.

# Testing

- For routes, write Vitest + Supertest specs in `__tests__`.

# Environment & Docs

- Validate env with Zod in `apps/api/src/config/env.ts`. Any new env var must be documented in `README.md` with defaults or examples.
- When adding routes, ensure OpenAPI docs remain accessible and update `README.md` endpoints if developer-facing.

# Comprehensive Documentation

- **API Development**: See `docs/DEVELOPMENT.md` for detailed API patterns, error handling, database models, and testing examples.
- **Architecture**: See `docs/ARCHITECTURE.md` for API design patterns, security considerations, and performance optimization.
- **Security**: See `docs/SECURITY.md` for API security best practices and vulnerability reporting.
